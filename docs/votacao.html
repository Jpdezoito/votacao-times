<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Votação</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f2f2f2;
            margin: 0;
            padding: 20px;
        }
        h1 { text-align: center; }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        input[type="number"] {
            width: 70px;
            padding: 4px;
        }
        .remove-btn {
            background: #ff4d4d;
            color: #fff;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
        }
        .remove-btn:hover { background: #e60000; }
        .vote-btn {
            padding: 4px 8px;
            cursor: pointer;
        }
        .small-text {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        .user-info {
            margin-bottom: 10px;
            font-size: 14px;
        }
        .user-info span {
            font-weight: bold;
        }
        button.logout {
            padding:4px 10px;
            margin-left:10px;
            border-radius:6px;
            border:none;
            background:#ccc;
            cursor:pointer;
        }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <h1>Votação para Equilibrar Times</h1>

    <div class="user-info">
        Logado como: <span id="currentUserName"></span>
        <button class="logout" onclick="logout()">Sair</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>Jogador</th>
            <th>Nota (0 a 10)</th>
            <th>Ação</th>
            <th>Média</th>
            <th>Votos</th>
            <th>Remover</th>
        </tr>
        </thead>
        <tbody id="playersBody">
        <!-- preenchido via JS -->
        </tbody>
    </table>

    <p class="small-text">
        Todos os jogadores desta lista são pessoas que fizeram cadastro. <br>
        As médias e votos são compartilhados entre todos.
    </p>
</div>

<script>
    const API_URL = "https://votacao-times.onrender.com";

    let playersCache = [];
    let currentUser = null;

    function logout() {
        localStorage.removeItem("votacao_user_name");
        window.location = "login.html";
    }

    async function loadPlayers() {
        const res = await fetch(API_URL + "/players");
        playersCache = await res.json();
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById("playersBody");
        tbody.innerHTML = "";

        playersCache.forEach(p => {
            const tr = document.createElement("tr");

            const tdName = document.createElement("td");
            tdName.textContent = p.name;
            tr.appendChild(tdName);

            const tdInput = document.createElement("td");
            const input = document.createElement("input");
            input.type = "number";
            input.min = "0";
            input.max = "10";
            input.step = "0.1";
            input.id = "nota_" + p.id;
            tdInput.appendChild(input);
            tr.appendChild(tdInput);

            const tdAction = document.createElement("td");
            const btn = document.createElement("button");
            btn.textContent = "Votar";
            btn.className = "vote-btn";
            btn.onclick = () => votePlayer(p.id);
            tdAction.appendChild(btn);
            tr.appendChild(tdAction);

            const tdMedia = document.createElement("td");
            tdMedia.id = "media_" + p.id;
            tdMedia.textContent = (p.votes > 0 && p.avg_score != null)
                ? p.avg_score.toFixed(2)
                : "-";
            tr.appendChild(tdMedia);

            const tdVotos = document.createElement("td");
            tdVotos.id = "votos_" + p.id;
            tdVotos.textContent = p.votes;
            tr.appendChild(tdVotos);

            const tdRemove = document.createElement("td");
            const rbtn = document.createElement("button");
            rbtn.textContent = "X";
            rbtn.className = "remove-btn";
            rbtn.onclick = () => removePlayer(p.id);
            tdRemove.appendChild(rbtn);
            tr.appendChild(tdRemove);

            tbody.appendChild(tr);
        });
    }

    async function votePlayer(id) {
        if (!currentUser) {
            alert("Faça login antes de votar.");
            window.location = "login.html";
            return;
        }

        const input = document.getElementById("nota_" + id);
        const nota = parseFloat(input.value);

        if (isNaN(nota) || nota < 0 || nota > 10) {
            alert("Digite uma nota entre 0 e 10.");
            return;
        }

        await fetch(API_URL + "/vote", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                player_id: id,
                score: nota,
                voter: currentUser
            })
        });

        input.value = "";
        await loadPlayers();
    }

    async function removePlayer(id) {
        if (!currentUser) {
            alert("Faça login antes de remover jogadores.");
            return;
        }

        if (!confirm("Remover este jogador e seus votos?")) return;

        await fetch(API_URL + "/players/" + id, {
            method: "DELETE"
        });

        await loadPlayers();
    }

    (function init() {
        const savedName = localStorage.getItem("votacao_user_name");
        if (!savedName) {
            window.location = "login.html";
            return;
        }
        currentUser = savedName;
        document.getElementById("currentUserName").textContent = currentUser;
        loadPlayers();
    })();
</script>

</body>
</html>
